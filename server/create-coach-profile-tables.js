const sql = require('mssql');

const config = {
    server: 'localhost',
    database: 'SMOKEKING',
    options: {
        encrypt: false,
        trustServerCertificate: true
    },
    authentication: {
        type: 'default',
        options: {
            userName: 'sa',
            password: '12345'
        }
    }
};

async function createCoachProfileTables() {
    try {
        await sql.connect(config);
        console.log('üîå Connected to database');

        // Create CoachProfiles table
        console.log('üìã Creating CoachProfiles table...');
        await sql.query`
            IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'CoachProfiles')
            BEGIN
                CREATE TABLE CoachProfiles (
                    ProfileID INT IDENTITY(1,1) PRIMARY KEY,
                    UserID INT NOT NULL,
                    Specialization NVARCHAR(255),
                    YearsOfExperience INT DEFAULT 0,
                    Education NVARCHAR(MAX),
                    Certifications NVARCHAR(MAX),
                    License NVARCHAR(255),
                    Bio NVARCHAR(MAX),
                    Methodology NVARCHAR(MAX),
                    SuccessStory NVARCHAR(MAX),
                    Languages NVARCHAR(255),
                    CommunicationStyle NVARCHAR(255),
                    WorkingHours NVARCHAR(255),
                    Website NVARCHAR(500),
                    LinkedIn NVARCHAR(500),
                    HourlyRate DECIMAL(10,2),
                    ConsultationFee DECIMAL(10,2),
                    ServicesOffered NVARCHAR(MAX),
                    TotalClientsServed INT DEFAULT 0,
                    SuccessRate DECIMAL(5,2) DEFAULT 0.0,
                    AverageRating DECIMAL(3,2) DEFAULT 0.0,
                    IsVerified BIT DEFAULT 0,
                    CreatedAt DATETIME DEFAULT GETDATE(),
                    UpdatedAt DATETIME DEFAULT GETDATE(),

                    FOREIGN KEY (UserID) REFERENCES Users(UserID)
                )
            END
        `;
        console.log('‚úÖ CoachProfiles table created successfully');

        // Create CoachReviews table
        console.log('üìã Creating CoachReviews table...');
        await sql.query`
            IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'CoachReviews')
            BEGIN
                CREATE TABLE CoachReviews (
                    ReviewID INT IDENTITY(1,1) PRIMARY KEY,
                    CoachUserID INT NOT NULL,
                    ClientUserID INT NULL,
                    ClientName NVARCHAR(255),
                    ReviewTitle NVARCHAR(255),
                    ReviewContent NVARCHAR(MAX),
                    Rating INT CHECK (Rating BETWEEN 1 AND 5),
                    IsAnonymous BIT DEFAULT 0,
                    IsPublic BIT DEFAULT 1,
                    CreatedAt DATETIME DEFAULT GETDATE(),

                    FOREIGN KEY (CoachUserID) REFERENCES Users(UserID),
                    FOREIGN KEY (ClientUserID) REFERENCES Users(UserID)
                )
            END
        `;
        console.log('‚úÖ CoachReviews table created successfully');

        // Get the coach user ID
        const coachResult = await sql.query`
            SELECT UserID FROM Users WHERE Email = 'coach@example.com' AND Role = 'coach'
        `;

        if (coachResult.recordset.length === 0) {
            console.log('‚ùå No coach found with email coach@example.com');
            return;
        }

        const coachId = coachResult.recordset[0].UserID;
        console.log(`üë§ Found coach with ID: ${coachId}`);

        // Check if coach already has a profile
        const existingProfile = await sql.query`
            SELECT ProfileID FROM CoachProfiles WHERE UserID = ${coachId}
        `;

        if (existingProfile.recordset.length > 0) {
            console.log('‚ÑπÔ∏è  Coach already has a profile, updating...');
            await sql.query`
                UPDATE CoachProfiles SET 
                    Specialization = N'Chuy√™n gia cai thu·ªëc l√°',
                    YearsOfExperience = 8,
                    Education = N'Th·∫°c sƒ© T√¢m l√Ω h·ªçc, ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi\nC·ª≠ nh√¢n Y khoa, ƒê·∫°i h·ªçc Y H√† N·ªôi',
                    Certifications = N'Ch·ª©ng ch·ªâ T∆∞ v·∫•n cai thu·ªëc qu·ªëc t·∫ø (CTTS)\nCh·ª©ng ch·ªâ T√¢m l√Ω tr·ªã li·ªáu h√†nh vi nh·∫≠n th·ª©c (CBT)\nCh·ª©ng ch·ªâ Hu·∫•n luy·ªán vi√™n s·ª©c kh·ªèe c·ªông ƒë·ªìng',
                    License = 'PSY-2024-HN-12345',
                    Bio = N'T√¥i l√† Hu·∫•n luy·ªán vi√™n chuy√™n nghi·ªáp v·ªõi h∆°n 8 nƒÉm kinh nghi·ªám gi√∫p m·ªçi ng∆∞·ªùi cai thu·ªëc l√° th√†nh c√¥ng. ƒê√£ h·ªó tr·ª£ h∆°n 500 kh√°ch h√†ng ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u s·ªëng kh·ªèe m·∫°nh kh√¥ng thu·ªëc l√°.\n\nPh∆∞∆°ng ph√°p c·ªßa t√¥i k·∫øt h·ª£p t√¢m l√Ω h·ªçc h√†nh vi, k·ªπ thu·∫≠t th∆∞ gi√£n v√† x√¢y d·ª±ng th√≥i quen t√≠ch c·ª±c. T√¥i tin r·∫±ng m·ªói ng∆∞·ªùi ƒë·ªÅu c√≥ th·ªÉ cai thu·ªëc th√†nh c√¥ng v·ªõi s·ª± h·ªó tr·ª£ ph√π h·ª£p.',
                    Methodology = N'Ph∆∞∆°ng ph√°p 4 b∆∞·ªõc STOP c·ªßa t√¥i:\n1. S - Set (ƒê·∫∑t m·ª•c ti√™u r√µ r√†ng)\n2. T - Track (Theo d√µi ti·∫øn tr√¨nh h√†ng ng√†y)\n3. O - Overcome (V∆∞·ª£t qua kh√≥ khƒÉn v·ªõi k·ªπ thu·∫≠t CBT)\n4. P - Persist (Duy tr√¨ th√†nh qu·∫£ l√¢u d√†i)\n\nK·∫øt h·ª£p v·ªõi:\n- T∆∞ v·∫•n t√¢m l√Ω c√° nh√¢n\n- Nh√≥m h·ªó tr·ª£ c·ªông ƒë·ªìng\n- ·ª®ng d·ª•ng c√¥ng ngh·ªá theo d√µi',
                    SuccessStory = N'M·ªôt trong nh·ªØng th√†nh c√¥ng ƒë√°ng nh·ªõ nh·∫•t l√† anh Minh - m·ªôt k·ªπ s∆∞ IT ƒë√£ h√∫t thu·ªëc 15 nƒÉm, 2 bao/ng√†y. Sau 3 th√°ng √°p d·ª•ng ph∆∞∆°ng ph√°p c·ªßa t√¥i, anh ƒë√£ cai thu·ªëc ho√†n to√†n v√† duy tr√¨ ƒë∆∞·ª£c 2 nƒÉm. Anh chia s·∫ª: "T√¥i kh√¥ng ch·ªâ cai ƒë∆∞·ª£c thu·ªëc m√† c√≤n t√¨m l·∫°i ƒë∆∞·ª£c s·ª©c kh·ªèe v√† t·ª± tin trong cu·ªôc s·ªëng."',
                    Languages = N'Ti·∫øng Vi·ªát (B·∫£n ng·ªØ), Ti·∫øng Anh (L∆∞u lo√°t)',
                    CommunicationStyle = N'Th√¢n thi·ªán, ki√™n nh·∫´n, t√≠ch c·ª±c v√† lu√¥n l·∫Øng nghe',
                    WorkingHours = N'Th·ª© 2 - Th·ª© 6: 8:00 - 17:00\nTh·ª© 7: 9:00 - 12:00\nCh·ªß nh·∫≠t: Ngh·ªâ (tr·ª´ tr∆∞·ªùng h·ª£p kh·∫©n c·∫•p)',
                    Website = 'https://caithocla-coach.vn',
                    LinkedIn = 'https://linkedin.com/in/coach-smith-quit-smoking',
                    HourlyRate = 200000,
                    ConsultationFee = 150000,
                    ServicesOffered = N'‚Ä¢ T∆∞ v·∫•n cai thu·ªëc c√° nh√¢n 1-1\n‚Ä¢ Nh√≥m h·ªó tr·ª£ cai thu·ªëc\n‚Ä¢ Ch∆∞∆°ng tr√¨nh cai thu·ªëc 30/60/90 ng√†y\n‚Ä¢ Theo d√µi v√† ƒë√°nh gi√° ti·∫øn tr√¨nh\n‚Ä¢ T∆∞ v·∫•n dinh d∆∞·ª°ng v√† th·ªÉ d·ª•c\n‚Ä¢ H·ªó tr·ª£ t√¢m l√Ω v∆∞·ª£t qua kh√≥ khƒÉn',
                    TotalClientsServed = 567,
                    SuccessRate = 89.5,
                    AverageRating = 4.8,
                    IsVerified = 1,
                    UpdatedAt = GETDATE()
                WHERE UserID = ${coachId}
            `;
            console.log('‚úÖ Updated existing coach profile');
        } else {
            console.log('üìù Creating new coach profile...');
            await sql.query`
                INSERT INTO CoachProfiles (
                    UserID, Specialization, YearsOfExperience, Education, Certifications, License,
                    Bio, Methodology, SuccessStory, Languages, CommunicationStyle, WorkingHours,
                    Website, LinkedIn, HourlyRate, ConsultationFee, ServicesOffered,
                    TotalClientsServed, SuccessRate, AverageRating, IsVerified
                ) VALUES (
                    ${coachId},
                    N'Chuy√™n gia cai thu·ªëc l√°',
                    8,
                    N'Th·∫°c sƒ© T√¢m l√Ω h·ªçc, ƒê·∫°i h·ªçc Qu·ªëc gia H√† N·ªôi\nC·ª≠ nh√¢n Y khoa, ƒê·∫°i h·ªçc Y H√† N·ªôi',
                    N'Ch·ª©ng ch·ªâ T∆∞ v·∫•n cai thu·ªëc qu·ªëc t·∫ø (CTTS)\nCh·ª©ng ch·ªâ T√¢m l√Ω tr·ªã li·ªáu h√†nh vi nh·∫≠n th·ª©c (CBT)\nCh·ª©ng ch·ªâ Hu·∫•n luy·ªán vi√™n s·ª©c kh·ªèe c·ªông ƒë·ªìng',
                    'PSY-2024-HN-12345',
                    N'T√¥i l√† Hu·∫•n luy·ªán vi√™n chuy√™n nghi·ªáp v·ªõi h∆°n 8 nƒÉm kinh nghi·ªám gi√∫p m·ªçi ng∆∞·ªùi cai thu·ªëc l√° th√†nh c√¥ng. ƒê√£ h·ªó tr·ª£ h∆°n 500 kh√°ch h√†ng ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u s·ªëng kh·ªèe m·∫°nh kh√¥ng thu·ªëc l√°.\n\nPh∆∞∆°ng ph√°p c·ªßa t√¥i k·∫øt h·ª£p t√¢m l√Ω h·ªçc h√†nh vi, k·ªπ thu·∫≠t th∆∞ gi√£n v√† x√¢y d·ª±ng th√≥i quen t√≠ch c·ª±c. T√¥i tin r·∫±ng m·ªói ng∆∞·ªùi ƒë·ªÅu c√≥ th·ªÉ cai thu·ªëc th√†nh c√¥ng v·ªõi s·ª± h·ªó tr·ª£ ph√π h·ª£p.',
                    N'Ph∆∞∆°ng ph√°p 4 b∆∞·ªõc STOP c·ªßa t√¥i:\n1. S - Set (ƒê·∫∑t m·ª•c ti√™u r√µ r√†ng)\n2. T - Track (Theo d√µi ti·∫øn tr√¨nh h√†ng ng√†y)\n3. O - Overcome (V∆∞·ª£t qua kh√≥ khƒÉn v·ªõi k·ªπ thu·∫≠t CBT)\n4. P - Persist (Duy tr√¨ th√†nh qu·∫£ l√¢u d√†i)\n\nK·∫øt h·ª£p v·ªõi:\n- T∆∞ v·∫•n t√¢m l√Ω c√° nh√¢n\n- Nh√≥m h·ªó tr·ª£ c·ªông ƒë·ªìng\n- ·ª®ng d·ª•ng c√¥ng ngh·ªá theo d√µi',
                    N'M·ªôt trong nh·ªØng th√†nh c√¥ng ƒë√°ng nh·ªõ nh·∫•t l√† anh Minh - m·ªôt k·ªπ s∆∞ IT ƒë√£ h√∫t thu·ªëc 15 nƒÉm, 2 bao/ng√†y. Sau 3 th√°ng √°p d·ª•ng ph∆∞∆°ng ph√°p c·ªßa t√¥i, anh ƒë√£ cai thu·ªëc ho√†n to√†n v√† duy tr√¨ ƒë∆∞·ª£c 2 nƒÉm. Anh chia s·∫ª: "T√¥i kh√¥ng ch·ªâ cai ƒë∆∞·ª£c thu·ªëc m√† c√≤n t√¨m l·∫°i ƒë∆∞·ª£c s·ª©c kh·ªèe v√† t·ª± tin trong cu·ªôc s·ªëng."',
                    N'Ti·∫øng Vi·ªát (B·∫£n ng·ªØ), Ti·∫øng Anh (L∆∞u lo√°t)',
                    N'Th√¢n thi·ªán, ki√™n nh·∫´n, t√≠ch c·ª±c v√† lu√¥n l·∫Øng nghe',
                    N'Th·ª© 2 - Th·ª© 6: 8:00 - 17:00\nTh·ª© 7: 9:00 - 12:00\nCh·ªß nh·∫≠t: Ngh·ªâ (tr·ª´ tr∆∞·ªùng h·ª£p kh·∫©n c·∫•p)',
                    'https://caithocla-coach.vn',
                    'https://linkedin.com/in/coach-smith-quit-smoking',
                    200000,
                    150000,
                    N'‚Ä¢ T∆∞ v·∫•n cai thu·ªëc c√° nh√¢n 1-1\n‚Ä¢ Nh√≥m h·ªó tr·ª£ cai thu·ªëc\n‚Ä¢ Ch∆∞∆°ng tr√¨nh cai thu·ªëc 30/60/90 ng√†y\n‚Ä¢ Theo d√µi v√† ƒë√°nh gi√° ti·∫øn tr√¨nh\n‚Ä¢ T∆∞ v·∫•n dinh d∆∞·ª°ng v√† th·ªÉ d·ª•c\n‚Ä¢ H·ªó tr·ª£ t√¢m l√Ω v∆∞·ª£t qua kh√≥ khƒÉn',
                    567,
                    89.5,
                    4.8,
                    1
                )
            `;
            console.log('‚úÖ Created new coach profile');
        }

        // Add some sample reviews
        console.log('üìù Adding sample reviews...');
        const existingReviews = await sql.query`
            SELECT COUNT(*) as ReviewCount FROM CoachReviews WHERE CoachUserID = ${coachId}
        `;

        if (existingReviews.recordset[0].ReviewCount === 0) {
            await sql.query`
                INSERT INTO CoachReviews (CoachUserID, ClientName, ReviewTitle, ReviewContent, Rating, IsAnonymous, IsPublic) VALUES 
                (${coachId}, N'Anh Minh T.', N'Cai thu·ªëc th√†nh c√¥ng sau 15 nƒÉm h√∫t!', N'T√¥i ƒë√£ h√∫t thu·ªëc 15 nƒÉm v√† th·ª≠ nhi·ªÅu c√°ch nh∆∞ng kh√¥ng th√†nh c√¥ng. Nh·ªù s·ª± h·ªó tr·ª£ t·∫≠n t√¨nh c·ªßa coach, t√¥i ƒë√£ cai ƒë∆∞·ª£c thu·ªëc ho√†n to√†n sau 3 th√°ng. Coach r·∫•t ki√™n nh·∫´n v√† ph∆∞∆°ng ph√°p r·∫•t hi·ªáu qu·∫£!', 5, 0, 1),
                (${coachId}, N'Ch·ªã Lan H.', N'Ph∆∞∆°ng ph√°p khoa h·ªçc v√† hi·ªáu qu·∫£', N'Ph∆∞∆°ng ph√°p c·ªßa coach k·∫øt h·ª£p t√¢m l√Ω h·ªçc v√† th·ª±c h√†nh, r·∫•t d·ªÖ √°p d·ª•ng. T√¥i ƒë√£ gi·∫£m t·ª´ 20 ƒëi·∫øu/ng√†y xu·ªëng 0 trong 2 th√°ng. C·∫£m ∆°n coach r·∫•t nhi·ªÅu!', 5, 0, 1),
                (${coachId}, N'Anh Nam K.', N'Chuy√™n nghi·ªáp v√† t·∫≠n t√¢m', N'Coach lu√¥n theo d√µi s√°t sao v√† ƒë·ªông vi√™n khi t√¥i g·∫∑p kh√≥ khƒÉn. Nh·ªù c√≥ coach m√† t√¥i ƒë√£ v∆∞·ª£t qua ƒë∆∞·ª£c giai ƒëo·∫°n kh√≥ khƒÉn nh·∫•t v√† gi·ªù ƒë√£ cai thu·ªëc ƒë∆∞·ª£c 6 th√°ng.', 5, 0, 1),
                (${coachId}, N'Ch·ªã Thu P.', N'Thay ƒë·ªïi cu·ªôc s·ªëng c·ªßa t√¥i', N'Kh√¥ng ch·ªâ gi√∫p t√¥i cai thu·ªëc, coach c√≤n gi√∫p t√¥i x√¢y d·ª±ng l·ªëi s·ªëng l√†nh m·∫°nh. S·ª©c kh·ªèe v√† tinh th·∫ßn t√¥i ƒë√£ t·ªët h∆°n r·∫•t nhi·ªÅu. R·∫•t bi·∫øt ∆°n coach!', 4, 0, 1),
                (${coachId}, N'Anh D≈©ng L.', N'K·∫øt qu·∫£ v∆∞·ª£t mong ƒë·ª£i', N'Ban ƒë·∫ßu t√¥i r·∫•t ho√†i nghi, nh∆∞ng sau khi l√†m vi·ªác v·ªõi coach, t√¥i th·ª±c s·ª± tin t∆∞·ªüng. Ph∆∞∆°ng ph√°p r·∫•t khoa h·ªçc v√† ph√π h·ª£p v·ªõi t·ª´ng ng∆∞·ªùi.', 4, 0, 1)
            `;
            console.log('‚úÖ Added sample reviews');
        } else {
            console.log('‚ÑπÔ∏è  Reviews already exist, skipping...');
        }

        // Update average rating in profile
        const avgRating = await sql.query`
            SELECT AVG(CAST(Rating AS FLOAT)) as AvgRating, COUNT(*) as ReviewCount
            FROM CoachReviews 
            WHERE CoachUserID = ${coachId} AND IsPublic = 1
        `;

        if (avgRating.recordset.length > 0) {
            const rating = avgRating.recordset[0].AvgRating || 0;
            await sql.query`
                UPDATE CoachProfiles 
                SET AverageRating = ${rating}
                WHERE UserID = ${coachId}
            `;
            console.log(`‚úÖ Updated average rating to: ${rating.toFixed(1)}`);
        }

        console.log('\nüéâ Coach profile tables and data setup complete!');
        console.log('üìã What was created/updated:');
        console.log('   ‚úÖ CoachProfiles table');
        console.log('   ‚úÖ CoachReviews table');
        console.log('   ‚úÖ Coach profile data for coach@example.com');
        console.log('   ‚úÖ Sample reviews and ratings');
        console.log('\nüåê Now you can login as coach and see full profile information!');

    } catch (error) {
        console.error('‚ùå Error:', error.message);
    } finally {
        await sql.close();
    }
}

createCoachProfileTables(); 